<!DOCTYPE html>
<html lang="en">
<head>
	<title>Terminal</title>
  <script>if(localStorage.getItem('_x_darkMode') !== 'false') { document.documentElement.classList.add('dark') }</script>
	<link rel="stylesheet" href="/assets/css/knot.css?_v={{ .version }}" />
	<script>
		window.terminalApp = function() {
			return {
				showKeyboard: false,
				modifiers: { ctrl: false, alt: false },
				terminal: null,

				init() {
					this.terminal = initializeTerminal({
						shell: "{{ .shell }}",
						renderer: "{{ .renderer }}",
						spaceId: "{{ .spaceId }}",
						logView: {{ .logView }},
					});
					
					document.addEventListener('keydown', (e) => {
						if (this.modifiers.ctrl || this.modifiers.alt) {
							e.preventDefault();
							this.sendKey(e.key);
						}
					});
				},

				toggleModifier(mod) {
					this.modifiers[mod] = !this.modifiers[mod];
				},

				sendKey(key) {
					if (!this.terminal) return;

					let input = key;

					if (this.modifiers.ctrl) {
						if (key.length === 1) {
							const code = key.toLowerCase().charCodeAt(0) - 96;
							input = String.fromCharCode(code);
						}
						this.modifiers.ctrl = false;
					}

					if (this.modifiers.alt) {
						input = '\x1b' + key;
						this.modifiers.alt = false;
					}

					this.terminal.input(input);
					this.terminal.focus();
				}
			}
		}
	</script>
</head>
<body x-data="terminalApp()">
	<div id="terminal" :class="{ 'terminal-with-keyboard': showKeyboard }"></div>
	{{ if not .logView }}
	<div class="soft-keyboard-container">
		<div x-show="!showKeyboard" @click="showKeyboard = true" class="keyboard-toggle">
			<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
				<path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
			</svg>
		</div>
		<div x-show="showKeyboard" class="soft-keyboard">
			<div class="keyboard-row">
				<button @click="toggleModifier('ctrl')" :class="{ 'active': modifiers.ctrl }" class="modifier-key">Ctrl</button>
				<button @click="toggleModifier('alt')" :class="{ 'active': modifiers.alt }" class="modifier-key">Alt</button>
				<button @click="sendKey('\x1b')" class="key">Esc</button>
				<button @click="sendKey('\t')" class="key">Tab</button>
				<button @click="sendKey('\x1b[A')" class="arrow-key">↑</button>
				<button @click="sendKey('\x1b[B')" class="arrow-key">↓</button>
				<button @click="sendKey('\x1b[D')" class="arrow-key">←</button>
				<button @click="sendKey('\x1b[C')" class="arrow-key">→</button>
				<button @click="showKeyboard = false" class="close-key">×</button>
			</div>
		</div>
	</div>
	{{ end }}
	<script src="/assets/js/knot.js?_v={{ .version }}" ></script>
</body>
</html>